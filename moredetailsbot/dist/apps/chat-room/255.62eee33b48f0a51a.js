(self.webpackChunkchat_room=self.webpackChunkchat_room||[]).push([[255],{1255:(e,t,a)=>{a.r(t),a.d(t,{default:()=>G});var o=a(8215),s=a(6638);const n=(0,s.createSlice)({name:"chatRoomApp",initialState:{chatRoomSlide:!1,chatRoomType:"",chatRoomChat:{id:0,isLoading:!1,wsErrors:[],isAdmin:!1,nominationCount:0,participantCount:0},chatRoomData:void 0},reducers:{setChatAccessToken:(e,t)=>{e.chatRoomChat.accessToken=t.payload},setChatRoomChatId:(e,t)=>{e.chatRoomChat.id=t.payload},initializePoll:(e,t)=>{e.chatRoomChat.poll=t.payload},loadingChat:(e,t)=>{e.chatRoomChat.isLoading=t.payload},showChatRoomSlide:(e,t)=>{e.chatRoomSlide=t.payload},typeChatRoom:(e,t)=>{e.chatRoomType=t.payload},dataChatRoom:(e,t)=>{e.chatRoomData=t.payload}}}),{showChatRoomSlide:i,typeChatRoom:r,dataChatRoom:c,initializePoll:l,loadingChat:d,setChatAccessToken:m,setChatRoomChatId:h}=n.actions,u=e=>e.chatRoomApp.chatRoomSlide,p=e=>e.chatRoomApp.chatRoomData,g=e=>e.chatRoomApp.chatRoomType,x=e=>e.chatRoomApp.chatRoomChat.id,f=n.reducer;var C=a(39),y=a(2885);const j=(0,C.L5)((0,C.cw)({baseUrl:"https://api80q.ru/mdws/chats"})),w=(0,y.xP)({reducerPath:"mdwsApi",refetchOnFocus:!0,baseQuery:j,tagTypes:["Validate"],endpoints:()=>({})}),v=w.injectEndpoints({endpoints:e=>({validate:e.query({query:e=>({url:`/validateUser/${e}`}),providesTags:["Validate"]}),join:e.mutation({query:({chat:e,user:t})=>({url:"/join",method:"POST",body:{chat:e,user:t}})}),getMessage:e.query({query:e=>({url:`/messages/${e}`})}),getUserById:e.query({query:e=>({url:`/users/${e}`})})})}),{useValidateQuery:R,useJoinMutation:k,useGetMessageQuery:S,useGetUserByIdQuery:b}=v,A=(0,s.configureStore)({reducer:{[w.reducerPath]:w.reducer,chatRoomApp:f},middleware:e=>e().concat(w.middleware)}),T=()=>(0,o.useDispatch)(),D=o.useSelector;var E=a(5932),L=a(1647),U=a(4343),P=a(1048),M=a(9179),N=a.n(M),q=a(3490);const B=e=>(0,M.useMemo)((()=>(0,q.io)("https://api80q.ru/chat",{auth:{token:e},transports:["websocket","polling"]})),[]);var O=a(1085);const I=({accessToken:e})=>{const t=(0,M.useRef)(null),a=D(x),o=D(p),{data:s,isSuccess:n,isLoading:i}=S(a),r=B(e),[c,l]=(0,M.useState)([]),[d,m]=(0,M.useState)("");return(0,M.useEffect)((()=>{t.current&&t.current.scrollIntoView({behavior:"smooth",block:"end"})}),[c]),(0,M.useEffect)((()=>{const e=e=>{l((t=>[...t,e])),console.log("args",e)};r.on("chat_updated",e),r.on("exception",e),r.on("message",e)}),[r]),console.log("socket",r),(0,O.jsxs)(U.A,{children:[i&&(0,O.jsx)(L.Preloader,{}),o&&n&&s.map((e=>(0,O.jsx)(P.A,{name:String(e.user),text:e.text,my:e.user===o.UserData.appUser},e.id))),c&&o&&c.map((e=>"message"===e.type&&e.text?(0,O.jsx)(P.A,{name:String(e.user.name),text:e.text.text,my:e.user.id===o.UserData.appUser},e.type):(0,O.jsx)(L.MessageSystem,{name:String(e.user.name),action:e.type,chat:String(e.chat.name),size:e.size}))),(0,O.jsx)("div",{className:"pb-4",ref:t}),(0,O.jsx)(L.SendPanel,{message:d,handleChange:e=>m(e.target.value),handleSubmit:e=>{e.trim(),""!=e&&(r.emit("message",e),m(""))}})]})};var z=a(6658),V=a.n(z);const _=new class{constructor(){this.peer=void 0,this.peer||(this.peer=new RTCPeerConnection({iceServers:[{urls:["stun:stun.l.google.com:19302","stun:global.stun.twilio.com:3478"]}]}))}async getAnswer(e){if(this.peer){await this.peer.setRemoteDescription(e);const t=await this.peer.createAnswer();return await this.peer.setLocalDescription(new RTCSessionDescription(t)),t}}async setLocalDescription(e){this.peer&&await this.peer.setRemoteDescription(new RTCSessionDescription(e))}async getOffer(){if(this.peer){const e=await this.peer.createOffer();return await this.peer.setLocalDescription(new RTCSessionDescription(e)),e}}},F=({accessToken:e})=>{const t=D(x),a=D(p),o=B(e),[s,n]=(0,M.useState)([]),[i,r]=(0,M.useState)(null),[c,l]=(0,M.useState)(),[d,m]=(0,M.useState)(),h=(0,M.useCallback)((({email:e,id:t})=>{console.log(`Email ${e} joined room`),r(t)}),[]),u=(0,M.useCallback)((async()=>{const e=await navigator.mediaDevices.getUserMedia({audio:!0,video:!0}),t=await _.getOffer();o.emit("user:call",{to:i,offer:t}),l(e)}),[i,o]),g=(0,M.useCallback)((async({from:e,offer:t})=>{r(e);const a=await navigator.mediaDevices.getUserMedia({audio:!0,video:!0});l(a),console.log("Incoming Call",e,t);const s=await _.getAnswer(t);o.emit("call:accepted",{to:e,ans:s})}),[o]),f=(0,M.useCallback)((()=>{if(c)for(const e of c.getTracks())_.peer.addTrack(e,c)}),[c]),C=(0,M.useCallback)((({from:e,ans:t})=>{_.setLocalDescription(t),console.log("Call Accepted!"),f()}),[f]),y=(0,M.useCallback)((async()=>{const e=await _.getOffer();o.emit("peer:nego:needed",{offer:e,to:i})}),[i,o]);(0,M.useEffect)((()=>(_.peer.addEventListener("negotiationneeded",y),()=>{_.peer.removeEventListener("negotiationneeded",y)})),[y]);const j=(0,M.useCallback)((async({from:e,offer:t})=>{const a=await _.getAnswer(t);o.emit("peer:nego:done",{to:e,ans:a})}),[o]),w=(0,M.useCallback)((async({ans:e})=>{await _.setLocalDescription(e)}),[]);return(0,M.useEffect)((()=>{_.peer.addEventListener("track",(async e=>{const t=e.streams;console.log("GOT TRACKS!!"),m(t[0])}))}),[]),(0,M.useEffect)((()=>(o.on("chat_updated",(e=>{n((t=>[...t,e])),console.log("args",e)})),o.on("user:joined",h),o.on("incomming:call",g),o.on("call:accepted",C),o.on("peer:nego:needed",j),o.on("peer:nego:final",w),()=>{o.off("user:joined",h),o.off("incomming:call",g),o.off("call:accepted",C),o.off("peer:nego:needed",j),o.off("peer:nego:final",w)})),[o,h,g,C,j,w]),(0,O.jsx)(U.A,{children:(0,O.jsxs)("div",{children:[(0,O.jsx)("h1",{children:"Room Page"}),a&&(0,O.jsx)("button",{className:"m-4 p-2 bg-slate-300 text-blue-800",onClick:()=>{return e=String(a.UserData.user.id),s=t,void o.emit("room:join",{email:e,room:s});var e,s},children:"Click JOIN"}),(0,O.jsx)("h4",{children:i?"Connected":"No one in room"}),c&&(0,O.jsx)("button",{onClick:f,children:"Send Stream"}),i&&(0,O.jsx)("button",{onClick:u,children:"CALL"}),c&&(0,O.jsxs)(O.Fragment,{children:[(0,O.jsx)("h1",{children:"My Stream"}),(0,O.jsx)(V(),{playing:!0,muted:!0,height:"270px",width:"360px",url:c})]}),d&&(0,O.jsxs)(O.Fragment,{children:[(0,O.jsx)("h1",{children:"Remote Stream"}),(0,O.jsx)(V(),{playing:!0,muted:!0,height:"270px",width:"360px",url:d})]})]})})},Q=({user:e})=>{const t=T(),a=D(u),o=D(g),[s,{data:n}]=k();return(0,E.z)(a,(()=>t(i(!1)))),(0,O.jsxs)(O.Fragment,{children:[(0,O.jsxs)("ul",{role:"list",className:"text-left divide-y divide-[var(--tg-theme-hint-color)]",children:[(0,O.jsx)(L.Contact,{handelClick:()=>{t(r("openChatRoom")),t(h(10)),t(i(!0)),s({chat:10,user:e.appUser})},img:"photo2024-02-11_17-14-16.jpg",name:"Антон",time:"17.03.24",lastMessage:"text"}),(0,O.jsx)(L.Contact,{handelClick:()=>{t(r("openVideoRoom")),t(h(10)),t(i(!0)),s({chat:11,user:e.appUser})},img:"photo2024-02-11_17-14-16.jpg",name:"Антон",time:"18.03.24",lastMessage:"video"})]}),(0,O.jsxs)(L.SlidePage,{slide:a,children:["openChatRoom"==o&&n&&(0,O.jsx)(I,{accessToken:n.accessToken}),"openVideoRoom"==o&&n&&(0,O.jsx)(F,{accessToken:n.accessToken})]})]})},$=()=>{const e=window.Telegram.WebApp,t=T(),{data:a,isSuccess:o}=R(e.initData);return o&&t(c(a)),(0,O.jsx)(O.Fragment,{children:a&&(0,O.jsx)(Q,{user:a.UserData})})},G=()=>{const e=window.Telegram.WebApp;return N().useEffect((()=>{e.expand(),e.ready()}),[]),(0,O.jsx)(o.Provider,{store:A,children:(0,O.jsx)($,{})})}},4343:(e,t,a)=>{a.d(t,{A:()=>n,X:()=>s});var o=a(1085);function s({children:e}){return(0,o.jsx)("div",{className:"flex flex-col px-2 overflow-auto w-screen h-screen pb-16",children:e})}const n=s},1048:(e,t,a)=>{a.d(t,{A:()=>i,e:()=>n});var o=a(5932),s=a(1085);function n({my:e,name:t,text:a}){const n=new Date;return(0,s.jsx)("div",{className:(0,o.x)(e?"justify-end":"","flex mb-2"),children:(0,s.jsxs)("div",{className:(0,o.x)(e?"text-right bg-[var(--tg-theme-button-color)]":"text-left bg-[var(--tg-theme-hint-color)]","rounded py-2 px-3 max-w-[75%]"),children:[!e&&(0,s.jsx)("p",{className:"text-sm text-left text-[var(--tg-theme-bg-color)]",children:t}),(0,s.jsx)("p",{className:"text-sm mt-4",children:a}),(0,s.jsx)("p",{className:"text-sm mt-4",children:n.toString()})]})})}const i=n},5932:(e,t,a)=>{a.d(t,{x:()=>n,z:()=>s});var o=a(9179);const s=(e,t)=>{const a=window.Telegram.WebApp;(0,o.useEffect)((()=>{e?(a.BackButton.show(),a.onEvent("backButtonClicked",(a.MainButton.hide(),t))):a.BackButton.hide()}),[e])},n=(...e)=>e.filter(Boolean).join(" ")}}]);