(self.webpackChunkchat_room=self.webpackChunkchat_room||[]).push([[243],{6243:(e,o,a)=>{a.d(o,{A:()=>K});var t=a(8215),n=a(6638);const s=(0,n.createSlice)({name:"chatRoomApp",initialState:{chatRoomSlide:!1,chatRoomType:"",chatRoomChat:{id:0,isLoading:!1,wsErrors:[],isAdmin:!1,nominationCount:0,participantCount:0},chatRoomData:void 0},reducers:{setChatAccessToken:(e,o)=>{e.chatRoomChat.accessToken=o.payload},setChatRoomChatId:(e,o)=>{e.chatRoomChat.id=o.payload},initializePoll:(e,o)=>{e.chatRoomChat.poll=o.payload},loadingChat:(e,o)=>{e.chatRoomChat.isLoading=o.payload},showChatRoomSlide:(e,o)=>{e.chatRoomSlide=o.payload},typeChatRoom:(e,o)=>{e.chatRoomType=o.payload},dataChatRoom:(e,o)=>{e.chatRoomData=o.payload}}}),{showChatRoomSlide:c,typeChatRoom:l,dataChatRoom:i,initializePoll:r,loadingChat:d,setChatAccessToken:m,setChatRoomChatId:g}=s.actions,h=e=>e.chatRoomApp.chatRoomSlide,u=e=>e.chatRoomApp.chatRoomData,p=e=>e.chatRoomApp.chatRoomType,f=e=>e.chatRoomApp.chatRoomChat.id,C=s.reducer;var x=a(39),j=a(2885);const k=(0,x.L5)((0,x.cw)({baseUrl:"https://api80q.ru/mdws/chats"})),w=(0,j.xP)({reducerPath:"mdwsApi",refetchOnFocus:!0,baseQuery:k,tagTypes:["Validate"],endpoints:()=>({})}),y=w.injectEndpoints({endpoints:e=>({validate:e.query({query:e=>({url:`/validateUser/${e}`}),providesTags:["Validate"]}),join:e.mutation({query:({chat:e,user:o})=>({url:"/join",method:"POST",body:{chat:e,user:o}})}),getMessage:e.query({query:e=>({url:`/messages/${e}`})}),getUserById:e.query({query:e=>({url:`/users/${e}`})})})}),{useValidateQuery:S,useJoinMutation:v,useGetMessageQuery:R,useGetUserByIdQuery:b}=y,T=(0,n.configureStore)({reducer:{[w.reducerPath]:w.reducer,chatRoomApp:C},middleware:e=>e().concat(w.middleware)}),A=()=>(0,t.useDispatch)(),D=t.useSelector;var L=a(5932),N=a(1647),E=a(4343),U=a(9179),M=a.n(U),I=a(3490);const O=e=>(0,U.useMemo)((()=>(0,I.io)("https://api80q.ru/chat",{auth:{token:e},transports:["websocket","polling"]})),[]);var P=a(1085);const F=({id:e,text:o})=>{const a=D(u),{data:t,isSuccess:n}=b(e);return(0,P.jsx)(P.Fragment,{children:a&&n&&(0,P.jsx)(N.MessageChat,{my:a.UserData.appUser===e,name:a.UserData.appUser===e?"":t.name,text:o})})},V=({accessToken:e})=>{const o=(0,U.useRef)(null),a=D(f),t=D(u),{data:n,isSuccess:s,isLoading:c}=R(a),l=O(e),[i,r]=(0,U.useState)([]),[d,m]=(0,U.useState)("");return(0,U.useEffect)((()=>{o.current&&o.current.scrollIntoView({behavior:"smooth",block:"end"})}),[i]),(0,U.useEffect)((()=>{const e=e=>{r((o=>[...o,e])),console.log("args",e)};l.on("chat_updated",e),l.on("exception",e),l.on("message",e)}),[l]),console.log("socket",l),(0,P.jsxs)(E.A,{children:[c&&(0,P.jsx)(N.Preloader,{}),t&&s&&n.map((e=>(0,P.jsx)(F,{id:e.user,text:e.text},e.id))),i&&t&&i.map((e=>"message"===e.type&&e.text?(0,P.jsx)(F,{id:e.user.id,text:e.text.text},e.type):(0,P.jsx)(N.MessageSystem,{name:String(e.user.name),action:e.type,chat:String(e.chat.name),size:e.size}))),(0,P.jsx)("div",{className:"pb-4",ref:o}),(0,P.jsx)(N.SendPanel,{message:d,handleChange:e=>m(e.target.value),handleSubmit:e=>{e.trim(),""!=e&&(l.emit("message",e),m(""))}})]})};var _=a(6658),q=a.n(_);const B=new class{constructor(){this.peer=void 0,this.peer||(this.peer=new RTCPeerConnection({iceServers:[{urls:["stun:stun.l.google.com:19302","stun:global.stun.twilio.com:3478"]}]}))}async getAnswer(e){if(this.peer){await this.peer.setRemoteDescription(e);const o=await this.peer.createAnswer();return await this.peer.setLocalDescription(new RTCSessionDescription(o)),o}}async setLocalDescription(e){this.peer&&await this.peer.setRemoteDescription(new RTCSessionDescription(e))}async getOffer(){if(this.peer){const e=await this.peer.createOffer();return await this.peer.setLocalDescription(new RTCSessionDescription(e)),e}}},G=({accessToken:e})=>{const o=D(f),a=D(u),t=O(e),[n,s]=(0,U.useState)([]),[c,l]=(0,U.useState)(null),[i,r]=(0,U.useState)(),[d,m]=(0,U.useState)();console.log("remoteSocketId",c),console.log("myStream",i),console.log("remoteStream",d);const g=(0,U.useCallback)((({email:e,id:o})=>{console.log(`Email ${e} joined room`),l(o)}),[]),h=(0,U.useCallback)((async()=>{console.log("handleCallUser");const e=await navigator.mediaDevices.getUserMedia({audio:!0,video:!0}),o=await B.getOffer();t.emit("user:call",{to:c,offer:o}),r(e)}),[c,t]),p=(0,U.useCallback)((async({from:e,offer:o})=>{console.log("handleIncommingCall"),l(e);const a=await navigator.mediaDevices.getUserMedia({audio:!0,video:!0});r(a),console.log("Incoming Call",e,o);const n=await B.getAnswer(o);t.emit("call:accepted",{to:e,ans:n})}),[t]),C=(0,U.useCallback)((()=>{if(console.log("sendStreams"),i)for(const e of i.getTracks())B.peer.addTrack(e,i)}),[i]),x=(0,U.useCallback)((({from:e,ans:o})=>{console.log("handleCallAccepted"),B.setLocalDescription(o),console.log("Call Accepted!"),C()}),[C]),j=(0,U.useCallback)((async()=>{console.log("handleNegoNeeded");const e=await B.getOffer();t.emit("peer:nego:needed",{offer:e,to:c})}),[c,t]);(0,U.useEffect)((()=>(B.peer.addEventListener("negotiationneeded",j),()=>{B.peer.removeEventListener("negotiationneeded",j)})),[j]);const k=(0,U.useCallback)((async({from:e,offer:o})=>{console.log("handleNegoNeedIncomming");const a=await B.getAnswer(o);t.emit("peer:nego:done",{to:e,ans:a})}),[t]),w=(0,U.useCallback)((async({ans:e})=>{console.log("handleNegoNeedFinal"),await B.setLocalDescription(e)}),[]);return(0,U.useEffect)((()=>{B.peer.addEventListener("track",(async e=>{const o=e.streams;console.log("GOT TRACKS!!"),m(o[0])}))}),[]),(0,U.useEffect)((()=>(t.on("chat_updated",(e=>{s((o=>[...o,e])),console.log("args",e)})),t.on("user:joined",g),t.on("incomming:call",p),t.on("call:accepted",x),t.on("peer:nego:needed",k),t.on("peer:nego:final",w),()=>{t.off("user:joined",g),t.off("incomming:call",p),t.off("call:accepted",x),t.off("peer:nego:needed",k),t.off("peer:nego:final",w)})),[t,g,p,x,k,w]),(0,P.jsx)(E.A,{children:(0,P.jsxs)("div",{children:[(0,P.jsx)("h1",{children:"Room Page"}),a&&(0,P.jsx)("button",{className:"m-4 p-2 bg-slate-300 text-blue-800",onClick:()=>{return e=String(a.UserData.user.id),n=o,void t.emit("room:join",{email:e,room:n});var e,n},children:"Click JOIN"}),(0,P.jsx)("h4",{children:c?"Connected":"No one in room"}),i&&(0,P.jsx)("button",{onClick:C,children:"Send Stream"}),c&&(0,P.jsx)("button",{onClick:h,children:"CALL"}),i&&(0,P.jsxs)(P.Fragment,{children:[(0,P.jsx)("h1",{children:"My Stream"}),(0,P.jsx)(q(),{playing:!0,muted:!0,height:"100px",width:"200px",url:i})]}),d&&(0,P.jsxs)(P.Fragment,{children:[(0,P.jsx)("h1",{children:"Remote Stream"}),(0,P.jsx)(q(),{playing:!0,muted:!0,height:"100px",width:"200px",url:d})]})]})})},z=({accessToken:e})=>{const o=D(f),a=(D(u),O(e)),[t,n]=(0,U.useState)([]),[s,c]=(0,U.useState)(null),[l,i]=(0,U.useState)(),[r,d]=(0,U.useState)();console.log("remoteSocketId",s),console.log("myStream",l),console.log("remoteStream",r);const m=(0,U.useCallback)((async()=>{console.log("handleCallUser");const e=await navigator.mediaDevices.getUserMedia({audio:!0,video:!0}),o=await B.getOffer();a.emit("user:call",{to:s,offer:o}),i(e)}),[s,a]),g=(0,U.useCallback)((async({from:e,offer:o})=>{console.log("handleIncommingCall"),c(e);const t=await navigator.mediaDevices.getUserMedia({audio:!0,video:!0});i(t),console.log("Incoming Call",e,o);const n=await B.getAnswer(o);a.emit("call:accepted",{to:e,ans:n})}),[a]),h=(0,U.useCallback)((()=>{if(console.log("sendStreams"),l)for(const e of l.getTracks())B.peer.addTrack(e,l)}),[l]),p=(0,U.useCallback)((({from:e,ans:o})=>{console.log("handleCallAccepted"),B.setLocalDescription(o),console.log("Call Accepted!"),h()}),[h]),C=(0,U.useCallback)((async()=>{console.log("handleNegoNeeded");const e=await B.getOffer();a.emit("peer:nego:needed",{offer:e,to:s})}),[s,a]);(0,U.useEffect)((()=>(B.peer.addEventListener("negotiationneeded",C),()=>{B.peer.removeEventListener("negotiationneeded",C)})),[C]);const x=(0,U.useCallback)((async({from:e,offer:o})=>{console.log("handleNegoNeedIncomming");const t=await B.getAnswer(o);a.emit("peer:nego:done",{to:e,ans:t})}),[a]),j=(0,U.useCallback)((async({ans:e})=>{console.log("handleNegoNeedFinal"),await B.setLocalDescription(e)}),[]);return(0,U.useEffect)((()=>{c(o),B.peer.addEventListener("track",(async e=>{const o=e.streams;console.log("GOT TRACKS!!"),d(o[0])}))}),[]),(0,U.useEffect)((()=>(a.on("chat_updated",(e=>{n((o=>[...o,e])),console.log("args",e)})),a.on("incomming:call",g),a.on("call:accepted",p),a.on("peer:nego:needed",x),a.on("peer:nego:final",j),()=>{a.off("incomming:call",g),a.off("call:accepted",p),a.off("peer:nego:needed",x),a.off("peer:nego:final",j)})),[a,g,p,x,j]),(0,P.jsx)(E.A,{children:(0,P.jsxs)("div",{children:[(0,P.jsx)("h1",{children:"Room Page"}),(0,P.jsx)("h4",{children:s?"Connected":"No one in room"}),l&&(0,P.jsx)("button",{onClick:h,children:"Send Stream"}),s&&(0,P.jsx)("button",{onClick:m,children:"CALL"}),l&&(0,P.jsxs)(P.Fragment,{children:[(0,P.jsx)("h1",{children:"My Stream"}),(0,P.jsx)(q(),{playing:!0,muted:!0,height:"270px",width:"360px",url:l})]}),r&&(0,P.jsxs)(P.Fragment,{children:[(0,P.jsx)("h1",{children:"Remote Stream"}),(0,P.jsx)(q(),{playing:!0,muted:!0,height:"270px",width:"360px",url:r})]})]})})},$=({accessToken:e})=>{const o=D(f),a=D(u),t=O(e),[n,s]=(0,U.useState)([]),[c,l]=(0,U.useState)(null),[i,r]=(0,U.useState)(),[d,m]=(0,U.useState)();console.log("remoteSocketId",c),console.log("myStream",i),console.log("remoteStream",d);const g=(0,U.useCallback)((({email:e,id:o})=>{console.log(`Email ${e} joined room`),l(o)}),[]),h=(0,U.useCallback)((async()=>{console.log("handleCallUser");const e=await navigator.mediaDevices.getUserMedia({audio:!0,video:!0}),o=await B.getOffer();t.emit("user:call",{to:c,offer:o}),r(e)}),[c,t]),p=(0,U.useCallback)((async({from:e,offer:o})=>{console.log("handleIncommingCall"),l(e);const a=await navigator.mediaDevices.getUserMedia({audio:!0,video:!0});r(a),console.log("Incoming Call",e,o);const n=await B.getAnswer(o);t.emit("call:accepted",{to:e,ans:n})}),[t]),C=(0,U.useCallback)((()=>{if(console.log("sendStreams"),i)for(const e of i.getTracks())B.peer.addTrack(e,i)}),[i]),x=(0,U.useCallback)((({from:e,ans:o})=>{console.log("handleCallAccepted"),B.setLocalDescription(o),console.log("Call Accepted!"),C()}),[C]),j=(0,U.useCallback)((async()=>{console.log("handleNegoNeeded");const e=await B.getOffer();t.emit("peer:nego:needed",{offer:e,to:c})}),[c,t]);(0,U.useEffect)((()=>(B.peer.addEventListener("negotiationneeded",j),()=>{B.peer.removeEventListener("negotiationneeded",j)})),[j]);const k=(0,U.useCallback)((async({from:e,offer:o})=>{console.log("handleNegoNeedIncomming");const a=await B.getAnswer(o);t.emit("peer:nego:done",{to:e,ans:a})}),[t]),w=(0,U.useCallback)((async({ans:e})=>{console.log("handleNegoNeedFinal"),await B.setLocalDescription(e)}),[]);return(0,U.useEffect)((()=>{B.peer.addEventListener("track",(async e=>{const o=e.streams;console.log("GOT TRACKS!!"),m(o[0])}))}),[]),(0,U.useEffect)((()=>(t.on("chat_updated",(e=>{s((o=>[...o,e])),console.log("args",e)})),t.on("user:joined",g),t.on("incomming:call",p),t.on("call:accepted",x),t.on("peer:nego:needed",k),t.on("peer:nego:final",w),()=>{t.off("user:joined",g),t.off("incomming:call",p),t.off("call:accepted",x),t.off("peer:nego:needed",k),t.off("peer:nego:final",w)})),[t,g,p,x,k,w]),(0,P.jsx)(E.A,{children:(0,P.jsxs)("div",{children:[(0,P.jsx)("h1",{children:"Room Page"}),a&&(0,P.jsx)("button",{className:"m-4 p-2 bg-slate-300 text-blue-800",onClick:()=>{return e=String(a.UserData.user.id),n=o,void t.emit("room:join",{email:e,room:n});var e,n},children:"Click JOIN"}),(0,P.jsx)("h4",{children:c?"Connected":"No one in room"}),i&&(0,P.jsx)("button",{onClick:C,children:"Send Stream"}),c&&(0,P.jsx)("button",{onClick:h,children:"CALL"}),i&&(0,P.jsxs)(P.Fragment,{children:[(0,P.jsx)("h1",{children:"My Stream"}),(0,P.jsx)(q(),{playing:!0,muted:!0,height:"100px",width:"200px",url:i})]}),d&&(0,P.jsxs)(P.Fragment,{children:[(0,P.jsx)("h1",{children:"Remote Stream"}),(0,P.jsx)(q(),{playing:!0,muted:!0,height:"100px",width:"200px",url:d})]})]})})},Q=({user:e})=>{const o=A(),a=D(h),t=D(p),[n,{data:s}]=v();return(0,L.z)(a,(()=>o(c(!1)))),(0,P.jsxs)(P.Fragment,{children:[(0,P.jsxs)("ul",{role:"list",className:"text-left divide-y divide-[var(--tg-theme-hint-color)]",children:[(0,P.jsx)(N.Contact,{handelClick:()=>{o(l("openChatRoom")),o(g(10)),o(c(!0)),n({chat:10,user:e.appUser})},img:"photo2024-02-11_17-14-16.jpg",name:"Антон",time:"17.03.24",lastMessage:"text"}),(0,P.jsx)(N.Contact,{handelClick:()=>{o(l("openVideoRoomMaster")),o(g(10)),o(c(!0)),n({chat:11,user:e.appUser})},img:"2024-03-18_23-35-47.png",name:"Антон",time:"18.03.24",lastMessage:"Видео стриммер"}),(0,P.jsx)(N.Contact,{handelClick:()=>{o(l("openVideoRoomGuest")),o(g(10)),o(c(!0)),n({chat:11,user:e.appUser})},img:"2024-03-18_23-35-23.png",name:"Антон",time:"18.03.24",lastMessage:"Видео гость"}),(0,P.jsx)(N.Contact,{handelClick:()=>{o(l("openVideoRoomT")),o(g(10)),o(c(!0)),n({chat:11,user:e.appUser})},img:"photo2024-02-11_17-14-16.jpg",name:"Антон",time:"19.03.24",lastMessage:"videoT"})]}),(0,P.jsxs)(N.SlidePage,{slide:a,children:["openChatRoom"===t&&s&&(0,P.jsx)(V,{accessToken:s.accessToken}),"openVideoRoomMaster"===t&&s&&(0,P.jsx)(G,{accessToken:s.accessToken}),"openVideoRoomGuest"===t&&s&&(0,P.jsx)($,{accessToken:s.accessToken}),"openVideoRoomT"===t&&s&&(0,P.jsx)(z,{accessToken:s.accessToken})]})]})},J=()=>{const e=window.Telegram.WebApp,o=A(),{data:a,isSuccess:t}=S(e.initData);return t&&o(i(a)),(0,P.jsx)(P.Fragment,{children:a&&(0,P.jsx)(Q,{user:a.UserData})})},K=()=>{const e=window.Telegram.WebApp;return M().useEffect((()=>{e.expand(),e.ready()}),[]),(0,P.jsx)(t.Provider,{store:T,children:(0,P.jsx)(J,{})})}},4343:(e,o,a)=>{a.d(o,{A:()=>s,X:()=>n});var t=a(1085);function n({children:e}){return(0,t.jsx)("div",{className:"flex flex-col px-2 overflow-auto w-screen h-screen pb-16",children:e})}const s=869!=a.j?n:null},5932:(e,o,a)=>{a.d(o,{x:()=>s,z:()=>n});var t=a(9179);const n=(e,o)=>{const a=window.Telegram.WebApp;(0,t.useEffect)((()=>{e?(a.BackButton.show(),a.onEvent("backButtonClicked",(a.MainButton.hide(),o))):a.BackButton.hide()}),[e])},s=(...e)=>e.filter(Boolean).join(" ")}}]);