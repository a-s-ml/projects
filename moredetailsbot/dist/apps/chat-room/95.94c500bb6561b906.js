(self.webpackChunkchat_room=self.webpackChunkchat_room||[]).push([[95],{8095:(e,t,a)=>{a.r(t),a.d(t,{default:()=>W});var o=a(8215),s=a(6638);const n=(0,s.createSlice)({name:"chatRoomApp",initialState:{chatRoomSlide:!1,chatRoomType:"",chatRoomChat:{id:0,isLoading:!1,wsErrors:[],isAdmin:!1,nominationCount:0,participantCount:0},chatRoomData:void 0},reducers:{setChatAccessToken:(e,t)=>{e.chatRoomChat.accessToken=t.payload},setChatRoomChatId:(e,t)=>{e.chatRoomChat.id=t.payload},initializePoll:(e,t)=>{e.chatRoomChat.poll=t.payload},loadingChat:(e,t)=>{e.chatRoomChat.isLoading=t.payload},showChatRoomSlide:(e,t)=>{e.chatRoomSlide=t.payload},typeChatRoom:(e,t)=>{e.chatRoomType=t.payload},dataChatRoom:(e,t)=>{e.chatRoomData=t.payload}}}),{showChatRoomSlide:c,typeChatRoom:i,dataChatRoom:r,initializePoll:l,loadingChat:d,setChatAccessToken:h,setChatRoomChatId:p}=n.actions,m=e=>e.chatRoomApp.chatRoomSlide,u=e=>e.chatRoomApp.chatRoomData,g=e=>e.chatRoomApp.chatRoomType,f=e=>e.chatRoomApp.chatRoomChat.id,C=n.reducer;var x=a(39),w=a(2885);const y=(0,x.L5)((0,x.cw)({baseUrl:"https://api80q.ru/mdws/chats"})),R=(0,w.xP)({reducerPath:"mdwsApi",refetchOnFocus:!0,baseQuery:y,tagTypes:["Validate"],endpoints:()=>({})}),j=R.injectEndpoints({endpoints:e=>({validate:e.query({query:e=>({url:`/validateUser/${e}`}),providesTags:["Validate"]}),join:e.mutation({query:({chat:e,user:t})=>({url:"/join",method:"POST",body:{chat:e,user:t}})}),getMessage:e.query({query:e=>({url:`/messages/${e}`})}),getUserById:e.query({query:e=>({url:`/users/${e}`})})})}),{useValidateQuery:k,useJoinMutation:v,useGetMessageQuery:S,useGetUserByIdQuery:T}=j,b=(0,s.configureStore)({reducer:{[R.reducerPath]:R.reducer,chatRoomApp:C},middleware:e=>e().concat(R.middleware)}),A=()=>(0,o.useDispatch)(),D=o.useSelector;var L=a(5932),U=a(1647),E=a(4343),M=a(9179),P=a.n(M),N=a(3490);const q=e=>(0,M.useMemo)((()=>(0,N.io)("https://api80q.ru/chat",{auth:{token:e},transports:["websocket","polling"]})),[]);var B=a(1085);const I=({id:e,text:t})=>{const a=D(u),{data:o,isSuccess:s}=T(e);return(0,B.jsx)(B.Fragment,{children:a&&s&&(0,B.jsx)(U.MessageChat,{my:a.UserData.appUser===e,name:a.UserData.appUser===e?"":o.name,text:t})})},F=({accessToken:e})=>{const t=(0,M.useRef)(null),a=D(f),o=D(u),{data:s,isSuccess:n,isLoading:c}=S(a),i=q(e),[r,l]=(0,M.useState)([]),[d,h]=(0,M.useState)("");return(0,M.useEffect)((()=>{t.current&&t.current.scrollIntoView({behavior:"smooth",block:"end"})}),[r]),(0,M.useEffect)((()=>{const e=e=>{l((t=>[...t,e])),console.log("args",e)};i.on("chat_updated",e),i.on("exception",e),i.on("message",e)}),[i]),console.log("socket",i),(0,B.jsxs)(E.A,{children:[c&&(0,B.jsx)(U.Preloader,{}),o&&n&&s.map((e=>(0,B.jsx)(I,{id:e.user,text:e.text},e.id))),r&&o&&r.map((e=>"message"===e.type&&e.text?(0,B.jsx)(I,{id:e.user.id,text:e.text.text},e.type):(0,B.jsx)(U.MessageSystem,{name:String(e.user.name),action:e.type,chat:String(e.chat.name),size:e.size}))),(0,B.jsx)("div",{className:"pb-4",ref:t}),(0,B.jsx)(U.SendPanel,{message:d,handleChange:e=>h(e.target.value),handleSubmit:e=>{e.trim(),""!=e&&(i.emit("message",e),h(""))}})]})};var O=a(6658),z=a.n(O);const V=new class{constructor(){this.peer=void 0,this.peer||(this.peer=new RTCPeerConnection({iceServers:[{urls:["stun:stun.l.google.com:19302","stun:global.stun.twilio.com:3478"]}]}))}async getAnswer(e){if(this.peer){await this.peer.setRemoteDescription(e);const t=await this.peer.createAnswer();return await this.peer.setLocalDescription(new RTCSessionDescription(t)),t}}async setLocalDescription(e){this.peer&&await this.peer.setRemoteDescription(new RTCSessionDescription(e))}async getOffer(){if(this.peer){const e=await this.peer.createOffer();return await this.peer.setLocalDescription(new RTCSessionDescription(e)),e}}},_=({accessToken:e})=>{const t=D(f),a=(D(u),q(e)),[o,s]=(0,M.useState)([]),[n,c]=(0,M.useState)(null),[i,r]=(0,M.useState)(),[l,d]=(0,M.useState)(),h=(0,M.useCallback)((async()=>{console.log("handleCallUser");const e=await navigator.mediaDevices.getUserMedia({audio:!0,video:!0}),t=await V.getOffer();a.emit("user:call",{to:n,offer:t}),r(e)}),[n,a]),p=(0,M.useCallback)((async({from:e,offer:t})=>{console.log("handleIncommingCall"),c(e);const o=await navigator.mediaDevices.getUserMedia({audio:!0,video:!0});r(o),console.log("Incoming Call",e,t);const s=await V.getAnswer(t);a.emit("call:accepted",{to:e,ans:s})}),[a]),m=(0,M.useCallback)((()=>{if(console.log("sendStreams"),i)for(const e of i.getTracks())V.peer.addTrack(e,i)}),[i]),g=(0,M.useCallback)((({from:e,ans:t})=>{console.log("handleCallAccepted"),V.setLocalDescription(t),console.log("Call Accepted!"),m()}),[m]),C=(0,M.useCallback)((async()=>{console.log("handleNegoNeeded");const e=await V.getOffer();a.emit("peer:nego:needed",{offer:e,to:n})}),[n,a]);(0,M.useEffect)((()=>(V.peer.addEventListener("negotiationneeded",C),()=>{V.peer.removeEventListener("negotiationneeded",C)})),[C]);const x=(0,M.useCallback)((async({from:e,offer:t})=>{console.log("handleNegoNeedIncomming");const o=await V.getAnswer(t);a.emit("peer:nego:done",{to:e,ans:o})}),[a]),w=(0,M.useCallback)((async({ans:e})=>{console.log("handleNegoNeedFinal"),await V.setLocalDescription(e)}),[]);return(0,M.useEffect)((()=>{c(t),V.peer.addEventListener("track",(async e=>{const t=e.streams;console.log("GOT TRACKS!!"),d(t[0])}))}),[]),(0,M.useEffect)((()=>(a.on("chat_updated",(e=>{s((t=>[...t,e])),console.log("args",e)})),a.on("incomming:call",p),a.on("call:accepted",g),a.on("peer:nego:needed",x),a.on("peer:nego:final",w),()=>{a.off("incomming:call",p),a.off("call:accepted",g),a.off("peer:nego:needed",x),a.off("peer:nego:final",w)})),[a,p,g,x,w]),(0,B.jsx)(E.A,{children:(0,B.jsxs)("div",{children:[(0,B.jsx)("h1",{children:"Room Page"}),(0,B.jsx)("h4",{children:n?"Connected":"No one in room"}),i&&(0,B.jsx)("button",{onClick:m,children:"Send Stream"}),n&&(0,B.jsx)("button",{onClick:h,children:"CALL"}),i&&(0,B.jsxs)(B.Fragment,{children:[(0,B.jsx)("h1",{children:"My Stream"}),(0,B.jsx)(z(),{playing:!0,muted:!0,height:"270px",width:"360px",url:i})]}),l&&(0,B.jsxs)(B.Fragment,{children:[(0,B.jsx)("h1",{children:"Remote Stream"}),(0,B.jsx)(z(),{playing:!0,muted:!0,height:"270px",width:"360px",url:l})]})]})})},Q=({user:e})=>{const t=A(),a=D(m),o=D(g),[s,{data:n}]=v();return(0,L.z)(a,(()=>t(c(!1)))),(0,B.jsxs)(B.Fragment,{children:[(0,B.jsxs)("ul",{role:"list",className:"text-left divide-y divide-[var(--tg-theme-hint-color)]",children:[(0,B.jsx)(U.Contact,{handelClick:()=>{t(i("openChatRoom")),t(p(10)),t(c(!0)),s({chat:10,user:e.appUser})},img:"photo2024-02-11_17-14-16.jpg",name:"Антон",time:"17.03.24",lastMessage:"text"}),(0,B.jsx)(U.Contact,{handelClick:()=>{t(i("openVideoRoom")),t(p(10)),t(c(!0)),s({chat:11,user:e.appUser})},img:"photo2024-02-11_17-14-16.jpg",name:"Антон",time:"18.03.24",lastMessage:"video"})]}),(0,B.jsxs)(U.SlidePage,{slide:a,children:["openChatRoom"==o&&n&&(0,B.jsx)(F,{accessToken:n.accessToken}),"openVideoRoom"==o&&n&&(0,B.jsx)(_,{accessToken:n.accessToken})]})]})},G=()=>{const e=window.Telegram.WebApp,t=A(),{data:a,isSuccess:o}=k(e.initData);return o&&t(r(a)),(0,B.jsx)(B.Fragment,{children:a&&(0,B.jsx)(Q,{user:a.UserData})})},W=()=>{const e=window.Telegram.WebApp;return P().useEffect((()=>{e.expand(),e.ready()}),[]),(0,B.jsx)(o.Provider,{store:b,children:(0,B.jsx)(G,{})})}},4343:(e,t,a)=>{a.d(t,{A:()=>n,X:()=>s});var o=a(1085);function s({children:e}){return(0,o.jsx)("div",{className:"flex flex-col px-2 overflow-auto w-screen h-screen pb-16",children:e})}const n=s},5932:(e,t,a)=>{a.d(t,{x:()=>n,z:()=>s});var o=a(9179);const s=(e,t)=>{const a=window.Telegram.WebApp;(0,o.useEffect)((()=>{e?(a.BackButton.show(),a.onEvent("backButtonClicked",(a.MainButton.hide(),t))):a.BackButton.hide()}),[e])},n=(...e)=>e.filter(Boolean).join(" ")}}]);