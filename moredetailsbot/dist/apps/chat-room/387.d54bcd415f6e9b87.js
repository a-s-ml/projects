(self.webpackChunkchat_room=self.webpackChunkchat_room||[]).push([[387],{1387:(e,t,o)=>{o.r(t);var a=o(9179),s=o.n(a),n=o(5873),i=o(8215),c=o(6638);const r=(0,c.createSlice)({name:"chatRoomApp",initialState:{chatRoomSlide:!1,chatRoomType:"",chatRoomChat:{id:0,isLoading:!1,wsErrors:[],isAdmin:!1,nominationCount:0,participantCount:0},chatRoomData:void 0},reducers:{setChatAccessToken:(e,t)=>{e.chatRoomChat.accessToken=t.payload},setChatRoomChatId:(e,t)=>{e.chatRoomChat.id=t.payload},initializePoll:(e,t)=>{e.chatRoomChat.poll=t.payload},loadingChat:(e,t)=>{e.chatRoomChat.isLoading=t.payload},showChatRoomSlide:(e,t)=>{e.chatRoomSlide=t.payload},typeChatRoom:(e,t)=>{e.chatRoomType=t.payload},dataChatRoom:(e,t)=>{e.chatRoomData=t.payload}}}),{showChatRoomSlide:l,typeChatRoom:d,dataChatRoom:h,initializePoll:m,loadingChat:p,setChatAccessToken:u,setChatRoomChatId:g}=r.actions,f=e=>e.chatRoomApp.chatRoomSlide,x=e=>e.chatRoomApp.chatRoomData,C=e=>e.chatRoomApp.chatRoomType,y=e=>e.chatRoomApp.chatRoomChat.id,j=r.reducer;var w=o(39),R=o(2885);const k=(0,w.L5)((0,w.cw)({baseUrl:"https://api80q.ru/mdws/chats"})),v=(0,R.xP)({reducerPath:"mdwsApi",refetchOnFocus:!0,baseQuery:k,tagTypes:["Validate"],endpoints:()=>({})}),S=v.injectEndpoints({endpoints:e=>({validate:e.query({query:e=>({url:`/validateUser/${e}`}),providesTags:["Validate"]}),join:e.mutation({query:({chat:e,user:t})=>({url:"/join",method:"POST",body:{chat:e,user:t}})}),getMessage:e.query({query:e=>({url:`/messages/${e}`})}),getUserById:e.query({query:e=>({url:`/users/${e}`})})})}),{useValidateQuery:b,useJoinMutation:T,useGetMessageQuery:A,useGetUserByIdQuery:D}=S,E=(0,c.configureStore)({reducer:{[v.reducerPath]:v.reducer,chatRoomApp:j},middleware:e=>e().concat(v.middleware)}),U=()=>(0,i.useDispatch)(),L=i.useSelector;var M=o(5932),N=o(1647),P=o(4343),B=o(3490);const I=e=>(0,a.useMemo)((()=>(0,B.io)("https://api80q.ru/chat",{auth:{token:e},transports:["websocket","polling"]})),[]);var q=o(1085);const O=({id:e,text:t})=>{const o=L(x),{data:a,isSuccess:s}=D(e);return(0,q.jsx)(q.Fragment,{children:o&&s&&(0,q.jsx)(N.MessageChat,{my:o.UserData.appUser===e,name:o.UserData.appUser===e?"":a.name,text:t})})},F=({accessToken:e})=>{const t=(0,a.useRef)(null),o=L(y),s=L(x),{data:n,isSuccess:i,isLoading:c}=A(o),r=I(e),[l,d]=(0,a.useState)([]),[h,m]=(0,a.useState)("");return(0,a.useEffect)((()=>{t.current&&t.current.scrollIntoView({behavior:"smooth",block:"end"})}),[l]),(0,a.useEffect)((()=>{const e=e=>{d((t=>[...t,e])),console.log("args",e)};r.on("chat_updated",e),r.on("exception",e),r.on("message",e)}),[r]),console.log("socket",r),(0,q.jsxs)(P.A,{children:[c&&(0,q.jsx)(N.Preloader,{}),s&&i&&n.map((e=>(0,q.jsx)(O,{id:e.user,text:e.text},e.id))),l&&s&&l.map((e=>"message"===e.type&&e.text?(0,q.jsx)(O,{id:e.user.id,text:e.text.text},e.type):(0,q.jsx)(N.MessageSystem,{name:String(e.user.name),action:e.type,chat:String(e.chat.name),size:e.size}))),(0,q.jsx)("div",{className:"pb-4",ref:t}),(0,q.jsx)(N.SendPanel,{message:h,handleChange:e=>m(e.target.value),handleSubmit:e=>{e.trim(),""!=e&&(r.emit("message",e),m(""))}})]})};var z=o(6658),V=o.n(z);const _=new class{constructor(){this.peer=void 0,this.peer||(this.peer=new RTCPeerConnection({iceServers:[{urls:["stun:stun.l.google.com:19302","stun:global.stun.twilio.com:3478"]}]}))}async getAnswer(e){if(this.peer){await this.peer.setRemoteDescription(e);const t=await this.peer.createAnswer();return await this.peer.setLocalDescription(new RTCSessionDescription(t)),t}}async setLocalDescription(e){this.peer&&await this.peer.setRemoteDescription(new RTCSessionDescription(e))}async getOffer(){if(this.peer){const e=await this.peer.createOffer();return await this.peer.setLocalDescription(new RTCSessionDescription(e)),e}}},Q=({accessToken:e})=>{const t=L(y),o=L(x),s=I(e),[n,i]=(0,a.useState)([]),[c,r]=(0,a.useState)(null),[l,d]=(0,a.useState)(),[h,m]=(0,a.useState)(),p=(0,a.useCallback)((({email:e,id:t})=>{console.log(`Email ${e} joined room`),r(t)}),[]),u=(0,a.useCallback)((async()=>{console.log("handleCallUser");const e=await navigator.mediaDevices.getUserMedia({audio:!0,video:!0}),t=await _.getOffer();s.emit("user:call",{to:c,offer:t}),d(e)}),[c,s]),g=(0,a.useCallback)((async({from:e,offer:t})=>{console.log("handleIncommingCall"),r(e);const o=await navigator.mediaDevices.getUserMedia({audio:!0,video:!0});d(o),console.log("Incoming Call",e,t);const a=await _.getAnswer(t);s.emit("call:accepted",{to:e,ans:a})}),[s]),f=(0,a.useCallback)((()=>{if(console.log("sendStreams"),l)for(const e of l.getTracks())_.peer.addTrack(e,l)}),[l]),C=(0,a.useCallback)((({from:e,ans:t})=>{console.log("handleCallAccepted"),_.setLocalDescription(t),console.log("Call Accepted!"),f()}),[f]),j=(0,a.useCallback)((async()=>{console.log("handleNegoNeeded");const e=await _.getOffer();s.emit("peer:nego:needed",{offer:e,to:c})}),[c,s]);(0,a.useEffect)((()=>(_.peer.addEventListener("negotiationneeded",j),()=>{_.peer.removeEventListener("negotiationneeded",j)})),[j]);const w=(0,a.useCallback)((async({from:e,offer:t})=>{console.log("handleNegoNeedIncomming");const o=await _.getAnswer(t);s.emit("peer:nego:done",{to:e,ans:o})}),[s]),R=(0,a.useCallback)((async({ans:e})=>{console.log("handleNegoNeedFinal"),await _.setLocalDescription(e)}),[]);return(0,a.useEffect)((()=>{_.peer.addEventListener("track",(async e=>{const t=e.streams;console.log("GOT TRACKS!!"),m(t[0])}))}),[]),(0,a.useEffect)((()=>(s.on("chat_updated",(e=>{i((t=>[...t,e])),console.log("args",e)})),s.on("user:joined",p),s.on("incomming:call",g),s.on("call:accepted",C),s.on("peer:nego:needed",w),s.on("peer:nego:final",R),()=>{s.off("user:joined",p),s.off("incomming:call",g),s.off("call:accepted",C),s.off("peer:nego:needed",w),s.off("peer:nego:final",R)})),[s,p,g,C,w,R]),(0,q.jsx)(P.A,{children:(0,q.jsxs)("div",{children:[(0,q.jsx)("h1",{children:"Room Page"}),o&&(0,q.jsx)("button",{className:"m-4 p-2 bg-slate-300 text-blue-800",onClick:()=>{return e=String(o.UserData.user.id),a=t,void s.emit("room:join",{email:e,room:a});var e,a},children:"Click JOIN"}),(0,q.jsx)("h4",{children:c?"Connected":"No one in room"}),l&&(0,q.jsx)("button",{onClick:f,children:"Send Stream"}),c&&(0,q.jsx)("button",{onClick:u,children:"CALL"}),l&&(0,q.jsxs)(q.Fragment,{children:[(0,q.jsx)("h1",{children:"My Stream"}),(0,q.jsx)(V(),{playing:!0,muted:!0,height:"270px",width:"360px",url:l})]}),h&&(0,q.jsxs)(q.Fragment,{children:[(0,q.jsx)("h1",{children:"Remote Stream"}),(0,q.jsx)(V(),{playing:!0,muted:!0,height:"270px",width:"360px",url:h})]})]})})},$=({user:e})=>{const t=U(),o=L(f),a=L(C),[s,{data:n}]=T();return(0,M.z)(o,(()=>t(l(!1)))),(0,q.jsxs)(q.Fragment,{children:[(0,q.jsxs)("ul",{role:"list",className:"text-left divide-y divide-[var(--tg-theme-hint-color)]",children:[(0,q.jsx)(N.Contact,{handelClick:()=>{t(d("openChatRoom")),t(g(10)),t(l(!0)),s({chat:10,user:e.appUser})},img:"photo2024-02-11_17-14-16.jpg",name:"Антон",time:"17.03.24",lastMessage:"text"}),(0,q.jsx)(N.Contact,{handelClick:()=>{t(d("openVideoRoom")),t(g(10)),t(l(!0)),s({chat:11,user:e.appUser})},img:"photo2024-02-11_17-14-16.jpg",name:"Антон",time:"18.03.24",lastMessage:"video"})]}),(0,q.jsxs)(N.SlidePage,{slide:o,children:["openChatRoom"==a&&n&&(0,q.jsx)(F,{accessToken:n.accessToken}),"openVideoRoom"==a&&n&&(0,q.jsx)(Q,{accessToken:n.accessToken})]})]})},G=()=>{const e=window.Telegram.WebApp,t=U(),{data:o,isSuccess:a}=b(e.initData);return a&&t(h(o)),(0,q.jsx)(q.Fragment,{children:o&&(0,q.jsx)($,{user:o.UserData})})},W=()=>{const e=window.Telegram.WebApp;return s().useEffect((()=>{e.expand(),e.ready()}),[]),(0,q.jsx)(i.Provider,{store:E,children:(0,q.jsx)(G,{})})};n.H(document.getElementById("root")).render((0,q.jsx)(a.StrictMode,{children:(0,q.jsx)(W,{})}))},4343:(e,t,o)=>{o.d(t,{A:()=>n,X:()=>s});var a=o(1085);function s({children:e}){return(0,a.jsx)("div",{className:"flex flex-col px-2 overflow-auto w-screen h-screen pb-16",children:e})}const n=s},5932:(e,t,o)=>{o.d(t,{x:()=>n,z:()=>s});var a=o(9179);const s=(e,t)=>{const o=window.Telegram.WebApp;(0,a.useEffect)((()=>{e?(o.BackButton.show(),o.onEvent("backButtonClicked",(o.MainButton.hide(),t))):o.BackButton.hide()}),[e])},n=(...e)=>e.filter(Boolean).join(" ")},5873:(e,t,o)=>{var a=o(67);t.H=a.createRoot,a.hydrateRoot}}]);